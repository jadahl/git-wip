#!/bin/bash

#  TODO:
#   - Check that we are at the tip of a branch with only one parent and no
#     mergepoints since the branch-off.
#   - Check that ${1} is a branch
#   - Try to find the branch we branched off of automatically (so that ${1}
#     isn't needed)

function autosquash {
    local flags branch

    if [ -z "${1}" ]; then
        echo "Usage: git wip autostash [<flags>] <branch>"
        exit 2
    fi

    flags=${*:1:$#-1}
    branch=${*: -1}

    EDITOR=true git rebase -i --autosquash "${flags[@]}" \
          "$(branch-off-point "${branch[@]}")"
}

# Get back the commit id of the point right before the first commit of
# this branch.
function branch-off-point {
    if [ -z "${1}" ]; then
        echo "Usage: git wip branch-off-point <branch>"
        exit 2
    fi

    git merge-base "${1}" "$(git rev-parse --abbrev-ref HEAD)"
}

function log {
    local flags branch

    if [ -z "${1}" ]; then
        echo "Usage: git wip log [<flags>] <branch>"
        exit 2
    fi

    flags=( ${@:1:$#-1} )
    branch=( ${@: -1} )
    git log "${flags[@]}" "$(branch-off-point "${branch[@]}")"..
}

function rework {
    if [ -z "${1}" ]; then
        echo "Usage: git wip rework [<flags>] <branch>"
        exit 2
    fi

    git rebase -i "$(branch-off-point "${1}")"
}

arg="${1}"
shift
case "${arg}" in
    autosquash)
        autosquash "${@}"
        ;;
    branch-off-point)
        branch-off-point "${@}"
        ;;
    log)
        log "${@}"
        ;;
    rework)
        rework "${@}"
        ;;
    *)
        echo "Usage: git wip [command] <flags>"
        exit 2
        ;;
esac
